{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/jsoneditor.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/pretty-print-json.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/easymde.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/easymde.min.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/pretty-print-json.css') }}" />
{% endblock %}
{% block title %}{{ action }}{% endblock %}
{% block content %}
<div class="modal" id="modalError" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="modal-title" class="modal-title">Action not permitted</h5>
      </div>
      <div class="modal-body">
        <p id="modal-error-text">Modal body text goes here.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col">
    <h2>{{ action | safe }}</h2>
  </div>
  <div class="col text-end">
    <div class="btn-group" role="group">
      <a type="button" id="savebundle" class="btn btn-primary" title="Save" aria-label="Save">Save</a>
      <a type="button" id="viewbundle" class="btn btn-primary {% if not bundle %}invisible{% endif %}" title="View" aria-label="View" href="{{ url_for('bundle_bp.get', bundle_uuid=bundle.uuid) }}">View</a>
      <a role="button" id="deletebundle" class="btn btn-danger {% if not bundle %}invisible{% endif %}" title="Delete" aria-label="Delete" href="{{ url_for('admin_bp.delete_bundle', bundle_uuid=bundle.uuid) }}" onclick="return confirm('You are going to delete this bundle.');">Delete</a>
    </div>
  </div>
</div>
<div id='editor'></div>
<br />
<script>
  let easyMDE = null;
  document.addEventListener("DOMContentLoaded", function() {
    // Retrieve the bundle
    fetch("{{ url_for('apiv1.bundle_bundle_item', bundle_uuid=bundle.uuid) }}")
    .then(response => response.json())
    .then(bundle => {
      // Retrieve the schema for the Bundle
      fetch("{{ url_for('static', filename='schemas/CIRCL/Security_Advisory_Bundle.json') }}")
      .then(response => response.json())
      .then(schema => {
        // Initialize the JSON editor
        initialize_editor(schema, bundle);
      })
      .catch((error) => {
        console.error('Error:', error);
      });
    })
    .catch((error) => {
      console.error('Error:', error);
    });
  });

  function initialize_editor(schema, json_object) {
    // Default starting schema
    if(!schema) {
      schema = {}
    }

    // Divs/textareas on the page
    var $schema = schema;
    var $output = document.getElementById('output');
    var $editor = document.getElementById('editor');

    // Default theme
    JSONEditor.defaults.options.theme = 'bootstrap5';

    window.startval = json_object;

    var jsoneditor;

    var reload = function(keep_value) {
      var startval = (jsoneditor && keep_value)? jsoneditor.getValue() : window.startval;
      window.startval = undefined;

      if (jsoneditor) {
        jsoneditor.destroy();
      }
      jsoneditor = new JSONEditor($editor, {
        // The schema for the editor
        schema: schema,
        // Remove collapse button
        disable_collapse: true,
        // Seed the form with a starting value
        startval: startval,
        // Enable fetching schemas via ajax
        ajax: true,
        // Disable additional properties
        no_additional_properties: false,
        // Require all properties by default
        required_by_default: true,
        show_opt_in: false,
        disable_edit_json: true,
        theme: "bootstrap5",
      });
      window.jsoneditor = jsoneditor;

      // When the value of the editor changes, update the JSON output and validation message
      jsoneditor.on('change',function() {
        var json = jsoneditor.getValue();
      });

      jsoneditor.on('ready', async () => {
        if (easyMDE  === null) {
          easyMDE = new EasyMDE({
            element: document.getElementById('root[description]'),
            autoRefresh: { delay: 300 },
            toolbarButtonClassPrefix: "mde",
            toolbar: [
              "bold", "italic", "heading", "|", "quote", "code", "table", "unordered-list", "ordered-list", "|", "link", "image", "|", "preview", "side-by-side", "fullscreen", "|",
              {
                name: "findCVE",
                action: (editor) => {
                  var cves = findCVEIdentifiers(editor.value());
                  var json = jsoneditor.getValue();
                  json["related_vulnerabilities"].push(...cves);
                  json["related_vulnerabilities"] = json["related_vulnerabilities"].filter(item => item !== "");
                  json["related_vulnerabilities"] = [...new Set(json["related_vulnerabilities"])];
                  jsoneditor.setValue(json);
                },
                className: "fa fa-bug",
                text: "",
                title: "Find CVEs",
                attributes: { // for custom attributes
                    id: "find-cve",
                    "data-value": "find-cve" // HTML5 data-* attributes need to be enclosed in quotation marks ("") because of the dash (-) in its name.
                }
              }
            ]
          });
        }
      });
    };

    // Start the schema and output textareas with initial values
    $schema.value = JSON.stringify(schema, null, 2);
    reload();
  };


  document.getElementById("savebundle").onclick = function(event) {
    var csrf_token = "{{ csrf_token() }}";
    var json = jsoneditor.getValue();
    json["description"] = easyMDE.value();
    data = JSON.stringify(json);
    fetch("{{ url_for('apiv1.bundle_bundles_list') }}", {
      method: "POST",
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrf_token
      },
      body: data
    })
    .then(res => {
      if (!res.ok) {
        res.json().then(json => {
          document.getElementById("modal-error-text").innerText = json['message'];
          document.getElementById("modal-title").innerText = "Error";
          var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
          modal.show();
        });
      } else {
        // reinitializes the form
        // window.jsoneditor.setValue({});
        // easyMDE.value("");

        res.json().then(json => {
          document.getElementById("viewbundle").href += json["data"][0]["uuid"];
          document.getElementById("deletebundle").href += json["data"][0]["uuid"];
          document.getElementById("viewbundle").classList.remove("invisible");
          document.getElementById("deletebundle").classList.remove("invisible");
        });

        document.getElementById("modal-error-text").innerText = "Bundle successfully saved.";
        document.getElementById("modal-title").innerText = "Success";
        var modal = new bootstrap.Modal(document.getElementById('modalError'), {});
        modal.show();
      }
    })
    .catch((error) => {
      console.log(error);
    });
  };
</script>
{% endblock %}
