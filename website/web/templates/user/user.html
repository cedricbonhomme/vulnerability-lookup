{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/luxon.min.js') }}"></script>
{% endblock %}
{% block title %}User: {{ user.login }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col">
    <h1>~/{{ user.login }}</h1>
  </div>
  <div class="col text-end">
    <a class="icon-link" href="{{ url_for('user_bp.feed_activity', login=user.login, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
    <a class="icon-link" href="{{ url_for('user_bp.feed_activity', login=user.login, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
  </div>
</div>
<div class="row">
    <div class="col">
       <p>{{ user.name }} has been a member since {{ user.created_at | datetimeformat('%B %d, %Y') }}
        and was last connected on {{ user.last_seen | datetimeformat('%B %d, %Y') }}.</p>
   </div>
</div>
{% if user.organisation %}
<div class="row">
    <div class="col">
       <p>This user is a member of {{ user.organisation }}.</p>
   </div>
</div>
{% endif %}
<div class="row">
  {% if user.bio %}
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Bio</h5>
        <p class="card-text">{{ user.bio | safe }}</p>
        {% if current_user.is_authenticated and current_user.id == user.id %}
        <hr style="border: 1px dashed black;" />
        <a class="icon-link" href="{{ url_for('user_bp.form') }}" title="Edit your profile">{{ render_icon('pen') }}</a>&nbsp;&nbsp;
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
  <div class="col text-start">
    <ul class="list-group">
      {% if user.webpage %}<li class="list-group-item">{{ render_icon('globe') }} <a href="{{ user.webpage }}" rel="noreferrer me" target="_blank">{{ user.webpage }}</a></li>{% endif %}
      {% if user.github %}<li class="list-group-item">{{ render_icon('github') }} <a href="https://github.com/{{ user.github }}" rel="noreferrer me" target="_blank">https://github.com/{{ user.github }}</a></li>{% endif %}
      {% if user.linkedin %}<li class="list-group-item">{{ render_icon('linkedin') }} <a href="https://www.linkedin.com/in/{{ user.linkedin }}" rel="noreferrer me" target="_blank">https://www.linkedin.com/in/{{ user.linkedin }}</a></li>{% endif %}
      {% if user.mastodon %}<li class="list-group-item">{{ render_icon('mastodon') }} <a href="{{ user.mastodon }}" rel="noreferrer me" target="_blank">{{ user.mastodon }}</a></li>{% endif %}
    </ul>
  </div>
</div>

<div class="row">
  <div class="col">
    <hr />
    <div class="row">
      <div class="col">
        <h3>Recent comments</h3>
      </div>
        <div class="col text-end">
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', user=user.login, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
          <a class="icon-link" href="{{ url_for('comments_bp.feed_comments', user=user.login, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
        </div>
    </div>
    <div id="list-comments">
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
        </div>
    </div>
    <p><a href="{{ url_for('comments_bp.list_comments') }}">All comments</a>.</p>
  </div>
  <div class="col">
    <div class="row">
      <div class="col">
        <h3>Recent bundles</h3>
      </div>
        <div class="col text-end">
          <a class="icon-link" href="{{ url_for('bundles_bp.feed_bundles', user=user.login, format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
          <a class="icon-link" href="{{ url_for('bundles_bp.feed_bundles', user=user.login, format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
        </div>
    </div>
    <div id="list-bundles">
      <div class="d-flex justify-content-center">
          <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
      </div>
    </div>
    <p><a href="{{ url_for('bundles_bp.list_bundles') }}">All bundles</a>.</p>
  </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var DateTime = luxon.DateTime;
        var converter = new showdown.Converter({tables: true});
        var commentTemplate = _.template(
        '<div class="card">' +
        '<div class="card-body">' +
        '<h5 class="card-title"><a href="/comment/<%= uuid %>"><%= title %></a></h5>' +
        '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %></h6>' +
        '<p class="card-text"><%= description %></p><hr />' +
        '<a class="btn btn-primary" href="/vuln/<%= vulnerability_id %>"><%= vulnerability_id %></a>' +
        '</div>');
        fetch("{{ url_for('apiv1.comment_comments_list', author=user.login) }}")
        .then(response => response.json())
        .then(result => {
        document.getElementById("list-comments").innerHTML = "";
        if (result.metadata.count == 0) {
            document.getElementById("list-comments").innerHTML = "<p>No comment.</p>";
        }
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (comment) {
            var cardHTML = commentTemplate({
            'uuid': comment.uuid,
            'title': comment.title,
            'description': converter.makeHtml(comment.description),
            'timestamp': DateTime.fromISO(comment.timestamp).toRelative(),
            'vulnerability_id': comment.vulnerability,
            });
            var element = document.createElement("div");
            var element_br = document.createElement("br");
            element.innerHTML = cardHTML;
            document.getElementById("list-comments").appendChild(element.firstChild);
            document.getElementById("list-comments").append(element_br);
        })
        })
        .catch((error) => {
        console.error('Error:', error);
        });

        var converter = new showdown.Converter({tables: true});
        var bundleTemplate = _.template(
            '<div class="card">' +
            '<div class="card-body">' +
            '<h5 class="card-title"><a href="/bundle/<%= uuid %>"><%= name %></a></h5>' +
            '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %></h6>' +
            '<p class="card-text"><%= description %></p>' +
            '<h5 class="card-text">Related vulnerabilities</h5>' +
            '<div class="card" >' +
            '<ul class="list-group list-group-flush">' +
            '<% _.forEach(related_vulnerabilities, function(vuln) ' +
                '{ %><li class="list-group-item"><a href="/vuln/<%= vuln %>"><%- vuln %></a></li><% }); %>' +
            '</ul>' +
            '</div>' +
            '</div>');
        fetch("{{ url_for('apiv1.bundle_bundles_list', author=user.login) }}")
        .then(response => response.json())
        .then(result => {
        document.getElementById("list-bundles").innerHTML = "";
        if (result.metadata.count == 0) {
            document.getElementById("list-bundles").innerHTML = "<p>No bundle.</p>";
        }
        result.data
        .sort(function (a, b) {
            return new Date(b.updated_at) - new Date(a.updated_at);
        })
        .map(function (bundle) {
            delete bundle.author;
            var cardHTML = bundleTemplate({
            'uuid': bundle.uuid,
            'name': bundle.name,
            'description': converter.makeHtml(bundle.description),
            'timestamp': DateTime.fromISO(bundle.timestamp).toRelative(),
            'related_vulnerabilities': bundle.related_vulnerabilities,
            });
            var element = document.createElement("div");
            var element_br = document.createElement("br");
            element.innerHTML = cardHTML;
            document.getElementById("list-bundles").appendChild(element.firstChild);
            document.getElementById("list-bundles").append(element_br);
        })
        })
        .catch((error) => {
        console.error('Error:', error);
        });
    });
</script>
{% endblock %}
