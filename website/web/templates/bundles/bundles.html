{% extends "main.html" %}
{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='js/showdown.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/lodash.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
{% endblock %}
{% block title %}Bundles{% endblock %}
{% block content %}
<h1>Recent bundles</h1>
<div class="row">
  <div class="col">
    {% if current_user.is_authenticated and current_user.is_admin %}
    <a id="buttonNewBundle" class="btn btn-primary" aria-expanded="false" href="{{ url_for('admin_bp.form_bundle') }}">New bundle</a>
    {% endif %}
  </div>
  <div class="col text-end">
      <a class="icon-link" href="{{ url_for('bundles_bp.feed_bundles', format='atom') }}" type="application/atom+xml" title="Atom feed">{{ render_icon('rss') }}</a>
      <a class="icon-link" href="{{ url_for('bundles_bp.feed_bundles', format='rss') }}" type="application/atom+xml" title="RSS feed">{{ render_icon('rss-fill') }}</a>
  </div>
</div>
<br />
<div id="list-bundles">
  <div class="d-flex justify-content-center">
      <div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    var DateTime = luxon.DateTime;
    var converter = new showdown.Converter({tables: true});
    var bundleTemplate = _.template(
        '<div class="card markdown-description">' +
        '<div class="card-body">' +
        '<h5 class="card-title"><a href="/bundle/<%= uuid %>"><%= name %></a></h5>' +
        '<h6 class="card-subtitle mb-2 text-body-secondary"><%= timestamp %> by <a href="/user/<%= author_login %>"><%= author_name %></a></h6>' +
        '<p class="card-text"><%= description %></p>' +
        'Related vulnerabilities: <% _.forEach(related_vulnerabilities, function(vuln) ' +
            '{ %><a href="/vuln/<%= vuln %>"><%- vuln %></a> <% }); %><br />' +
        '</div>');
    fetch("{{ url_for('apiv1.bundle_bundles_list') }}")
    .then(response => response.json())
    .then(result => {
    document.getElementById("list-bundles").innerHTML = "";
    if (result.metadata.count == 0) {
        document.getElementById("list-bundles").innerHTML = "<p>No bundle.</p>";
    }
    result.data
    .sort(function (a, b) {
        return new Date(b.updated_at) - new Date(a.updated_at);
    })
    .map(function (bundle) {
        var author = bundle.author
        delete bundle.author;

        var description = converter.makeHtml(bundle.description);
        description = linkifySecurityIdentifiers(description);

        var cardHTML = bundleTemplate({
        'uuid': bundle.uuid,
        'name': bundle.name,
        'description': description,
        'timestamp': DateTime.fromISO(bundle.timestamp).toRelative(),
        'related_vulnerabilities': bundle.related_vulnerabilities.map(v => v.toLowerCase()),
        'author_name': author.name,
        'author_login': author.login
        });
        var element = document.createElement("div");
        var element_br = document.createElement("br");
        element.innerHTML = cardHTML;
        document.getElementById("list-bundles").appendChild(element.firstChild);
        document.getElementById("list-bundles").append(element_br);
    })
    })
    .then(_ => {
      setTimeout(() => {
        formatMarkdownOutput();
      }, 0);  // 0ms delay still allows the browser to update the DOM
    })
    .catch((error) => {
    console.error('Error:', error);
    });
  });
</script>
{% endblock %}
