#!/usr/bin/env python3

from __future__ import annotations

from subprocess import Popen, run

from redis import Redis
from redis.exceptions import ConnectionError

from vulnerabilitylookup.default import get_homedir, get_socket_path


def main() -> None:
    get_homedir()
    p = Popen(["shutdown"])
    p.wait()
    try:
        r = Redis(unix_socket_path=get_socket_path("cache"), db=1)
        r.delete("shutdown")
        print("Shutting down databases...")
        p_backend = run(["run_backend", "--stop"])
        p_backend.check_returncode()
        print("done.")
    except ConnectionError:
        # Already down, skip the stacktrace
        print(
            "WARNING: Redis is down, unable to remove the `shutdown` key from the redis cache database, DB 1. Remove the key manually if the website does not start."
        )


if __name__ == "__main__":
    main()
